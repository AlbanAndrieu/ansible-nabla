#sudo ansible-playbook -i hosts-albandri -c local -v nexus.yml -vvvv | tee setup.log

- hosts: all
  gather_facts: true
  tasks:
    - name: group hosts by distribution
      group_by: key="{{ ansible_distribution }}-{{ ansible_distribution_version }}"

- hosts: RedHat-7*:RedHat-6*:RedHat-5*:CentOS-7*:CentOS-6*:Ubuntu-17*:Ubuntu-16*:Ubuntu-15*:Ubuntu-14*:Ubuntu-13*:Ubuntu-12*
  gather_facts: false
  tasks:
    - name: group hosts for supported distributions
      group_by: key="supported"

- hosts: "!supported"
  gather_facts: false
  tasks:
    - name: fail for unsupported distribution
      fail: msg="{{ ansible_distribution }} {{ ansible_distribution_version }}
                 is not a supported OS for a Tower installation.  Supported
                 OSes include Red Hat Enterprise Linux 6/7/5, CentOS 6, or
                 Ubuntu 12.04/13.04/14.04/15.04/16.04/17.04."
    - debug: msg="Version {{ ansible_distribution }} {{ ansible_distribution_version }} {{ ansible_architecture }}"

- name: Install nexus
  hosts: nexus
  remote_user: root

  roles:
    - role: nexus

  vars:
      nexus_home: "/usr/local/{{nexus_user}}"
      #nexus_version: "2.7.1"

      ## Repositories Section
      nexus_repositories :
         - id                                              : "central"
           name                                            : "Central"
           providerRole                                    : "org.sonatype.nexus.proxy.repository.Repository"
           providerHint                                    : "maven2"
           localStatus                                     : "IN_SERVICE"
           notFoundCacheActive                             : "true"
           notFoundCacheTTL                                : "1440"
           userManaged                                     : "true"
           exposed                                         : "true"
           browseable                                      : "true"
           writePolicy                                     : "READ_ONLY"
           indexable                                       : "true"
           searchable                                      : "true"
           localStorage                                    : "file"
           remoteStorage                                   : "http://repo1.maven.org/maven2/"
           externalConfiguration_proxyMode                 : "ALLOW"
           externalConfiguration_artifactMaxAge            : "-1"
           externalConfiguration_itemMaxAge                : "1440"
           externalConfiguration_cleanseRepositoryMetadata : "false"
           externalConfiguration_downloadRemoteIndex       : "false"
           externalConfiguration_checksumPolicy            : "WARN"
           externalConfiguration_repositoryPolicy          : "RELEASE"

         - id                                              : "apache-snapshots"
           name                                            : "Apache Snapshots"
           providerRole                                    : "org.sonatype.nexus.proxy.repository.Repository"
           providerHint                                    : "maven2"
           localStatus                                     : "IN_SERVICE"
           notFoundCacheActive                             : "true"
           notFoundCacheTTL                                : "1440"
           userManaged                                     : "true"
           exposed                                         : "true"
           browseable                                      : "true"
           writePolicy                                     : "READ_ONLY"
           indexable                                       : "true"
           searchable                                      : "true"
           localStorage                                    : "file"
           remoteStorage                                   : "http://repository.apache.org/snapshots/"
           externalConfiguration_proxyMode                 : "ALLOW"
           externalConfiguration_artifactMaxAge            : "1440"
           externalConfiguration_itemMaxAge                : "1440"
           externalConfiguration_cleanseRepositoryMetadata : "false"
           externalConfiguration_downloadRemoteIndex       : "false"
           externalConfiguration_checksumPolicy            : "WARN"
           externalConfiguration_repositoryPolicy          : "SNAPSHOT"

         - id                                              : "codehaus-snapshots"
           name                                            : "Codehaus Snapshots"
           providerRole                                    : "org.sonatype.nexus.proxy.repository.Repository"
           providerHint                                    : "maven2"
           localStatus                                     : "IN_SERVICE"
           notFoundCacheActive                             : "true"
           notFoundCacheTTL                                : "1440"
           userManaged                                     : "true"
           exposed                                         : "true"
           browseable                                      : "true"
           writePolicy                                     : "READ_ONLY"
           indexable                                       : "true"
           searchable                                      : "true"
           localStorage                                    : "file"
           remoteStorage                                   : "http://nexus.codehaus.org/snapshots/"
           externalConfiguration_proxyMode                 : "ALLOW"
           externalConfiguration_artifactMaxAge            : "1440"
           externalConfiguration_itemMaxAge                : "1440"
           externalConfiguration_cleanseRepositoryMetadata : "false"
           externalConfiguration_downloadRemoteIndex       : "false"
           externalConfiguration_checksumPolicy            : "WARN"
           externalConfiguration_repositoryPolicy          : "SNAPSHOT"

         - id                                              : "releases"
           name                                            : "Releases"
           providerRole                                    : "org.sonatype.nexus.proxy.repository.Repository"
           providerHint                                    : "maven2"
           localStatus                                     : "IN_SERVICE"
           notFoundCacheTTL                                : "1440"
           userManaged                                     : "true"
           exposed                                         : "true"
           browseable                                      : "true"
           writePolicy                                     : "ALLOW_WRITE_ONCE"
           indexable                                       : "true"
           searchable                                      : "true"
           localStorage                                    : "file"
           externalConfiguration_proxyMode                 : "ALLOW"
           externalConfiguration_artifactMaxAge            : "-1"
           externalConfiguration_itemMaxAge                : "1440"
           externalConfiguration_cleanseRepositoryMetadata : "false"
           externalConfiguration_downloadRemoteIndex       : "false"
           externalConfiguration_checksumPolicy            : "WARN"
           externalConfiguration_repositoryPolicy          : "RELEASE"

         - id                                              : "snapshots"
           name                                            : "Snapshots"
           providerRole                                    : "org.sonatype.nexus.proxy.repository.Repository"
           providerHint                                    : "maven2"
           localStatus                                     : "IN_SERVICE"
           notFoundCacheTTL                                : "1440"
           itemMaxAge                                      : "1440"
           userManaged                                     : "true"
           exposed                                         : "true"
           browseable                                      : "true"
           writePolicy                                     : "ALLOW_WRITE"
           indexable                                       : "true"
           searchable                                      : "true"
           localStorage                                    : "file"
           externalConfiguration_proxyMode                 : "ALLOW"
           externalConfiguration_artifactMaxAge            : "1440"
           externalConfiguration_itemMaxAge                : "1440"
           externalConfiguration_cleanseRepositoryMetadata : "false"
           externalConfiguration_downloadRemoteIndex       : "false"
           externalConfiguration_checksumPolicy            : "WARN"
           externalConfiguration_repositoryPolicy          : "SNAPSHOT"

         - id                                              : "thirdparty"
           name                                            : "3rd party"
           providerRole                                    : "org.sonatype.nexus.proxy.repository.Repository"
           providerHint                                    : "maven2"
           localStatus                                     : "IN_SERVICE"
           notFoundCacheTTL                                : "1440"
           userManaged                                     : "true"
           exposed                                         : "true"
           browseable                                      : "true"
           writePolicy                                     : "ALLOW_WRITE_ONCE"
           indexable                                       : "true"
           searchable                                      : "true"
           localStorage                                    : "file"
           externalConfiguration_proxyMode                 : "ALLOW"
           externalConfiguration_artifactMaxAge            : "-1"
           externalConfiguration_itemMaxAge                : "1440"
           externalConfiguration_cleanseRepositoryMetadata : "false"
           externalConfiguration_downloadRemoteIndex       : "false"
           externalConfiguration_checksumPolicy            : "WARN"
           externalConfiguration_repositoryPolicy          : "RELEASE"

         - id                                              : "central-m1"
           name                                            : "Central M1 shadow"
           providerRole                                    : "org.sonatype.nexus.proxy.repository.ShadowRepository"
           providerHint                                    : "m2-m1-shadow"
           localStatus                                     : "IN_SERVICE"
           notFoundCacheTTL                                : "15"
           userManaged                                     : "true"
           exposed                                         : "true"
           browseable                                      : "true"
           writePolicy                                     : "READ_ONLY"
           localStorage                                    : "file"
           externalConfiguration_masterRepositoryId        : "central"
           externalConfiguration_syncAtStartup             : "false"

         - id                                              : "public"
           name                                            : "Public Repositories"
           providerRole                                    : "org.sonatype.nexus.proxy.repository.GroupRepository"
           providerHint                                    : "maven2"
           localStatus                                     : "IN_SERVICE"
           notFoundCacheTTL                                : "15"
           userManaged                                     : "true"
           exposed                                         : "true"
           browseable                                      : "true"
           writePolicy                                     : "READ_ONLY"
           indexable                                       : "true"
           localStorage                                    : "file"
           externalConfiguration_mergeMetadata             : "true"
           externalConfiguration_memberRepositories        :
              - "releases"
              - "snapshots"
              - "thirdparty"
              - "central"

         - id                                              : "nabla"
           name                                            : "Nabla Repositories"
           providerRole                                    : "org.sonatype.nexus.proxy.repository.Repository"
           providerHint                                    : "maven2"
           localStatus                                     : "IN_SERVICE"
           notFoundCacheActive                             : "true"
           notFoundCacheTTL                                : "1440"
           userManaged                                     : "true"
           exposed                                         : "true"
           browseable                                      : "true"
           writePolicy                                     : "READ_ONLY"
           indexable                                       : "true"
           searchable                                      : "true"
           localStorage                                    : "file"
           remoteStorage                                   : "http://home.nabla.mobi:8085/nexus/content/groups/public/"
           externalConfiguration_proxyMode                 : "ALLOW"
           externalConfiguration_artifactMaxAge            : "1440"
           externalConfiguration_itemMaxAge                : "1440"
           externalConfiguration_cleanseRepositoryMetadata : "false"
           externalConfiguration_downloadRemoteIndex       : "false"
           externalConfiguration_checksumPolicy            : "WARN"
           externalConfiguration_repositoryPolicy          : "RELEASE"

         - id                                              : "nabla-releases"
           name                                            : "Nabla Releases Repositories"
           providerRole                                    : "org.sonatype.nexus.proxy.repository.Repository"
           providerHint                                    : "maven2"
           localStatus                                     : "IN_SERVICE"
           notFoundCacheActive                             : "true"
           notFoundCacheTTL                                : "1440"
           userManaged                                     : "true"
           exposed                                         : "true"
           browseable                                      : "true"
           writePolicy                                     : "READ_ONLY"
           indexable                                       : "true"
           searchable                                      : "true"
           localStorage                                    : "file"
           remoteStorage                                   : "http://home.nabla.mobi:8085/nexus/content/repositories/releases/"
           externalConfiguration_proxyMode                 : "ALLOW"
           externalConfiguration_artifactMaxAge            : "1440"
           externalConfiguration_itemMaxAge                : "1440"
           externalConfiguration_cleanseRepositoryMetadata : "false"
           externalConfiguration_downloadRemoteIndex       : "false"
           externalConfiguration_checksumPolicy            : "WARN"
           externalConfiguration_repositoryPolicy          : "RELEASE"

         - id                                              : "nabla-snapshots"
           name                                            : "Nabla Snapshots Repositories"
           providerRole                                    : "org.sonatype.nexus.proxy.repository.Repository"
           providerHint                                    : "maven2"
           localStatus                                     : "IN_SERVICE"
           notFoundCacheActive                             : "true"
           notFoundCacheTTL                                : "1440"
           userManaged                                     : "true"
           exposed                                         : "true"
           browseable                                      : "true"
           writePolicy                                     : "READ_ONLY"
           indexable                                       : "true"
           searchable                                      : "true"
           localStorage                                    : "file"
           remoteStorage                                   : "http://home.nabla.mobi:8085/nexus/content/repositories/snapshots/"
           externalConfiguration_proxyMode                 : "ALLOW"
           externalConfiguration_artifactMaxAge            : "1440"
           externalConfiguration_itemMaxAge                : "1440"
           externalConfiguration_cleanseRepositoryMetadata : "false"
           externalConfiguration_downloadRemoteIndex       : "false"
           externalConfiguration_checksumPolicy            : "WARN"
           externalConfiguration_repositoryPolicy          : "SNAPSHOT"

#TODO remove
#TODO add authentificatio by hand
         - id                                              : "work-test"
           name                                            : "WORK TEST Repositories"
           providerRole                                    : "org.sonatype.nexus.proxy.repository.Repository"
           providerHint                                    : "maven2"
           localStatus                                     : "IN_SERVICE"
           notFoundCacheActive                             : "true"
           notFoundCacheTTL                                : "1440"
           userManaged                                     : "true"
           exposed                                         : "true"
           browseable                                      : "true"
           writePolicy                                     : "READ_ONLY"
           indexable                                       : "true"
           searchable                                      : "true"
           localStorage                                    : "file"
           remoteStorage                                   : "http://test/nexus/content/groups/test-public/"
           externalConfiguration_proxyMode                 : "ALLOW"
           externalConfiguration_artifactMaxAge            : "1440"
           externalConfiguration_itemMaxAge                : "1440"
           externalConfiguration_cleanseRepositoryMetadata : "false"
           externalConfiguration_downloadRemoteIndex       : "false"
           externalConfiguration_checksumPolicy            : "WARN"
           externalConfiguration_repositoryPolicy          : "RELEASE"

#TODO remove
#TODO add authentificatio by hand
         - id                                              : "work"
           name                                            : "WORK Repositories"
           providerRole                                    : "org.sonatype.nexus.proxy.repository.Repository"
           providerHint                                    : "maven2"
           localStatus                                     : "IN_SERVICE"
           notFoundCacheActive                             : "true"
           notFoundCacheTTL                                : "1440"
           userManaged                                     : "true"
           exposed                                         : "true"
           browseable                                      : "true"
           writePolicy                                     : "READ_ONLY"
           indexable                                       : "true"
           searchable                                      : "true"
           localStorage                                    : "file"
           remoteStorage                                   : "http://test/maven/content/groups/public/"
           externalConfiguration_proxyMode                 : "ALLOW"
           externalConfiguration_artifactMaxAge            : "1440"
           externalConfiguration_itemMaxAge                : "1440"
           externalConfiguration_cleanseRepositoryMetadata : "false"
           externalConfiguration_downloadRemoteIndex       : "false"
           externalConfiguration_checksumPolicy            : "WARN"
           externalConfiguration_repositoryPolicy          : "RELEASE"
