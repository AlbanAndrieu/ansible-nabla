#as albandri
#ansible-playbook opencl.yml -i hosts-production --limit pricer.nabla.mobi -vvvv --ask-sudo-pass --sudo

#TODO service lightdm stop
# pkill -u jenkins
# pkill -u jenkins-bm

- hosts: opencl
  become: yes
  remote_user: root

  pre_tasks:
    - set_fact:
       cpu_driver: "{% if 'GenuineIntel' in ansible_processor %}intel{% elif 'AuthenticAMD' in ansible_processor %}amd{%else%}unknown{%endif%}"

    - debug: msg="{{cpu_driver}}"

    - command: "dkms status"

#Remove older nvidia driver from kernel
    #modprobe -v nvidia-uvm
    #dpkg -l | grep nvidia
    #apt-get remove nvidia-*
    #apt-get purge nvidia-304

- name: Configure opencl
  hosts: opencl
  become: yes
  remote_user: root
  ignore_errors: true
  #connection: local

  roles:
    - opencl

  vars:
    nvidia_driver_version: 352.41
    #nvidia_driver_version: 304.132
    base_url: "http://home.nabl.mobi/download/opencl"
    kmod_install: true

    #modprobe -v nvidia-uvm

#cat /proc/driver/nvidia/version

#sudo update-alternatives --config opencl-intel-runtime
