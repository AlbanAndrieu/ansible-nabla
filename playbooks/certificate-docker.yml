
- name: Install Docker CA root certificate
  hosts: docker
  become: true
  check_mode: no
  ignore_errors: yes
  remote_user: root

#See /root/pki/docker.pem
  roles:
    - role: ssl-ca-certificate
      trust_ca_pki_dir: '~/pki'
      trust_ca_pki_prefix: 'registry'
      trust_ca_cert_prefix: 'registry'

#TODO secure docker https://docs.docker.com/engine/security/https/
#mkdir -pv ~/.docker
#cp -v {ca,registry,cert,key}.pem ~/.docker
#docker --tlsverify ps

- hosts: docker
#  remote_user: root

  tasks:
    - name: Create .docker
      file: path=~/.docker state=directory mode=0700
      become: true
      become_user: root

    - name: Create registry
      file: path=/etc/docker/certs.d/registry.nabla.mobi/ state=directory mode=0700
      become: true
      become_user: root

    #- name: Copy docker registry pem crt
    #  copy:
    #    src: ~/pki/registry.pem
    #    dest: "{{ item }}"
    #    remote_src: yes
    #  with_items:
    #    - ~/.docker/registry.crt
    #    - /etc/docker/certs.d/registry.nabla.mobi/registry.crt
    #  become: true
    #  become_user: root

    - name: Copy ca pem crt
      copy:
        src: ~/pki/ca.pem
        dest: "{{ item }}"
        remote_src: yes
      with_items:
        - ~/.docker/ca.crt
        - /etc/docker/certs.d/registry.nabla.mobi/ca.crt
      become: true
      check_mode: no
      ignore_errors: yes
      become_user: root
